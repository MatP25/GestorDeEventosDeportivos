@using GestorEventosDeportivos.Modules.Carreras.Application.Services
@using GestorEventosDeportivos.Modules.Carreras.Domain.Entities
@using GestorEventosDeportivos.Modules.Carreras.Domain.Enums
@using GestorEventosDeportivos.Modules.ProgresoCarreras.Domain.Entities
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.JSInterop

@inject ICarreraService CarreraService
@inject NavigationManager Nav
@inject IJSRuntime JS

<div class="card mt-3">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
            <div class="small text-muted">Actualización en vivo (SignalR)</div>
        </div>

        @if (cargando)
        {
            <p class="mt-2">Cargando…</p>
        }
        else if (!string.IsNullOrEmpty(error))
        {
            <div class="alert alert-danger mt-2">@error</div>
        }
        else if (_orden.Count == 0)
        {
            <p class="text-muted mt-2">No hay participantes registrados.</p>
        }
        else
        {
            <div class="mt-2" style="max-height: 60vh; overflow: auto;">
                <table class="table table-sm align-middle mb-0">
                    <thead class="table-light" style="position: sticky; top: 0; z-index: 1;">
                        <tr>
                            <th>#</th>
                            <th>Participante</th>
                            <th>Número</th>
                            <th>Estado</th>
                            <th>Tiempo</th>
                            <th>Puesto</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (var i = 0; i < _orden.Count; i++)
                        {
                            var p = _orden[i];
                            <tr>
                                <td>@(i + 1)</td>
                                <td>@p.Participante?.Nombre @p.Participante?.Apellido</td>
                                <td>@p.NumeroCorredor</td>
                                <td><span class="badge @GetEstadoPartBadge(p.Estado)">@p.Estado</span></td>
                                <td>@TiempoDeParticipante(p)</td>
                                <td>@(i + 1)</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
    
</div>

@code {
    [Parameter] public Guid CarreraId { get; set; }

    private Carrera? _carrera;
    private List<Participacion> _participaciones = new();
    private List<Participacion> _orden = new();
    private bool cargando = true;
    private string? error;

    private uint? _ultimaPosicionPc;
    private HubConnection? _hub; // Fallback C#
    private IJSObjectReference? _raceModule;
    private DotNetObjectReference<CarreraEnCursoPanel>? _dotNetRef;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            cargando = true;
            error = null;

            _carrera = await CarreraService.ObtenerCarreraConDetalle(CarreraId);
            if (_carrera is null)
            {
                error = "Carrera no encontrada";
                return;
            }
            _ultimaPosicionPc = _carrera.PuntosDeControl?.Count > 0
                ? _carrera.PuntosDeControl.Max(pc => pc.Posicion)
                : null;

            await CargarParticipacionesAsync();

            bool jsOk = false;
            try
            {
                _raceModule = await JS.InvokeAsync<IJSObjectReference>("import", "/js/raceHub.js");
                _dotNetRef = DotNetObjectReference.Create(this);
                await _raceModule.InvokeVoidAsync("setupRaceHub", _dotNetRef, CarreraId.ToString());
                jsOk = true;
            }
            catch
            {
                jsOk = false;
            }

            if (!jsOk)
            {
                _hub = new HubConnectionBuilder()
                    .WithUrl(Nav.ToAbsoluteUri("/hubs/race"))
                    .WithAutomaticReconnect()
                    .Build();

                _hub.On<Guid>("RaceUpdated", async raceId =>
                {
                    if (raceId == CarreraId)
                    {
                        await CargarParticipacionesAsync();
                        await InvokeAsync(StateHasChanged);
                    }
                });

                await _hub.StartAsync();
                await _hub.InvokeAsync("JoinRaceGroup", CarreraId.ToString());
            }
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
        finally
        {
            cargando = false;
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_hub is not null)
        {
            try { await _hub.DisposeAsync(); } catch { }
        }
        if (_raceModule is not null)
        {
            try { await _raceModule.InvokeVoidAsync("stopRaceHub"); } catch { }
        }
        _dotNetRef?.Dispose();
    }

    [JSInvokable]
    public async Task OnRaceUpdatedDotNet(Guid raceId)
    {
        if (raceId == CarreraId)
        {
            await CargarParticipacionesAsync();
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task CargarParticipacionesAsync()
    {
        if (_carrera is null) return;
        try
        {
            var capacidad = (int)(_carrera.Evento?.CapacidadParticipantes ?? 1000);
            var page = await CarreraService.ListarParticipacionesCarreraPaginado(_carrera.Id, 1, capacidad);
            _participaciones = page.Items.ToList();
            _orden = OrdenarPorDesempeno(_participaciones);
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }

    private List<Participacion> OrdenarPorDesempeno(IEnumerable<Participacion> parts)
    {
        int StateRank(EstadoParticipanteEnCarrera e) => e switch
        {
            EstadoParticipanteEnCarrera.EnCurso => 0,
            EstadoParticipanteEnCarrera.Completada => 0,
            EstadoParticipanteEnCarrera.SinComenzar => 2,
            EstadoParticipanteEnCarrera.Abandonada => 3,
            _ => 2
        };

        (uint pos, TimeSpan time) Key(Participacion p)
        {
            if (p.Progreso != null && p.Progreso.Count > 0)
            {
                var maxPc = p.Progreso.Keys.Max();
                var t = p.Progreso[maxPc];
                return (maxPc, t);
            }
            return (0u, TimeSpan.MaxValue);
        }

        return parts
            .OrderBy(p => StateRank(p.Estado))
            .ThenByDescending(p => Key(p).pos)
            .ThenBy(p => Key(p).time)
            .ThenBy(p => p.NumeroCorredor ?? uint.MaxValue)
            .ThenBy(p => (p.Participante?.Apellido ?? "") + (p.Participante?.Nombre ?? ""))
            .ToList();
    }

    private string TiempoDeParticipante(Participacion p)
    {
        if (p.Progreso == null || p.Progreso.Count == 0)
            return "--";

        if (_ultimaPosicionPc.HasValue && p.Progreso.TryGetValue(_ultimaPosicionPc.Value, out var tpc))
            return FormatearTiempo(tpc);

        var maxTiempo = p.Progreso.Values.Max();
        return FormatearTiempo(maxTiempo);
    }

    private static string FormatearTiempo(TimeSpan t)
    {
        if (t.TotalHours >= 1)
            return $"{(int)t.TotalHours:00}:{t.Minutes:00}:{t.Seconds:00}";
        return $"{t.Minutes:00}:{t.Seconds:00}";
    }

    private string GetEstadoPartBadge(EstadoParticipanteEnCarrera est)
    {
        return est switch
        {
            EstadoParticipanteEnCarrera.SinComenzar => "text-bg-info",
            EstadoParticipanteEnCarrera.EnCurso => "text-bg-warning",
            EstadoParticipanteEnCarrera.Completada => "text-bg-success",
            EstadoParticipanteEnCarrera.Abandonada => "text-bg-secondary",
            _ => "text-bg-light"
        };
    }
}
